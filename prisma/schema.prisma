generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int               @id @default(autoincrement())
  email            String            @unique
  password         String
  name             String?
  isSuperAdmin     Boolean           @default(false)
  workspaceMembers WorkspaceMember[]
  projectRoles     ProjectRole[]
  refreshToken     String?
  testRuns         TestRun[]
  testRunItems     TestRunItem[]
  attachments      Attachment[]
  fileAssets       FileAsset[]       @relation("FileAssetUploadedBy")
  docsCreated      Doc[]             @relation("DocCreatedBy")
  docsUpdated      Doc[]             @relation("DocUpdatedBy")
  docVersions      DocVersion[]      @relation("DocVersionCreatedBy")
  docReviewRequested DocReviewWorkflow[] @relation("DocReviewRequestedBy")
  docReviewDecided DocReviewWorkflow[] @relation("DocReviewDecidedBy")
  docReviewActions DocReviewAction[] @relation("DocReviewActionActor")
  docCommentsCreated DocComment[] @relation("DocCommentCreatedBy")
  docCommentsResolved DocComment[] @relation("DocCommentResolvedBy")
  docTemplatesCreated DocTemplate[] @relation("DocTemplateCreatedBy")
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
}

model Workspace {
  id         Int               @id @default(autoincrement())
  slug       String            @unique
  name       String
  members    WorkspaceMember[]
  projects   Project[]
  suites     Suite[]
  testCases  TestCase[]
  testRuns   TestRun[]
  docs       Doc[]
  docFolders DocFolder[]
  docTemplates DocTemplate[]
  fileAssets FileAsset[]
  rolePermissionSets RolePermissionSet[]
}

model WorkspaceMember {
  id          Int       @id @default(autoincrement())
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId Int
  user        User      @relation(fields: [userId], references: [id])
  userId      Int
  role        String
  customPermissions String[] // Custom permissions override for this member

  @@unique([workspaceId, userId])
  @@index([workspaceId])
}

model Project {
  id          Int           @id @default(autoincrement())
  key         String
  name        String
  workspace   Workspace     @relation(fields: [workspaceId], references: [id])
  workspaceId Int
  roles       ProjectRole[]
  suites      Suite[]
  testCases   TestCase[]
  testRuns    TestRun[]
  docs        Doc[]
  docFolders  DocFolder[]
  docTemplates DocTemplate[]
  fileAssets  FileAsset[]

  @@index([workspaceId])
}

model ProjectRole {
  id        Int     @id @default(autoincrement())
  project   Project @relation(fields: [projectId], references: [id])
  projectId Int
  user      User    @relation(fields: [userId], references: [id])
  userId    Int
  role      String
  customPermissions String[] // Custom permissions override for this role

  @@unique([projectId, userId])
  @@index([projectId])
  @@index([userId])
}

model Suite {
  id          Int        @id @default(autoincrement())
  name        String
  order       Int        @default(0)
  project     Project    @relation(fields: [projectId], references: [id])
  projectId   Int
  workspace   Workspace  @relation(fields: [workspaceId], references: [id])
  workspaceId Int
  parent      Suite?     @relation("SuiteToSuite", fields: [parentId], references: [id])
  parentId    Int?
  children    Suite[]    @relation("SuiteToSuite")
  testCases   TestCase[]
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([projectId])
  @@index([workspaceId])
  @@index([parentId])
}

model TestCase {
  id          Int           @id @default(autoincrement())
  key         String
  title       String
  status      String        @default("draft")
  priority    String        @default("medium")
  tags        String[]
  version     Int           @default(1)
  project     Project       @relation(fields: [projectId], references: [id])
  projectId   Int
  workspace   Workspace     @relation(fields: [workspaceId], references: [id])
  workspaceId Int
  suite       Suite?        @relation(fields: [suiteId], references: [id])
  suiteId     Int?
  steps       TestStep[]
  runItems    TestRunItem[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([projectId, key])
  @@index([workspaceId])
  @@index([suiteId])
}

model TestStep {
  id         Int       @id @default(autoincrement())
  order      Int       @default(0)
  action     String
  expected   String
  testCase   TestCase  @relation(fields: [testCaseId], references: [id])
  testCaseId Int
}

model TestRun {
  id          Int           @id @default(autoincrement())
  project     Project       @relation(fields: [projectId], references: [id])
  projectId   Int
  workspace   Workspace     @relation(fields: [workspaceId], references: [id])
  workspaceId Int
  build       String
  env         String
  platform    String
  createdBy   User          @relation(fields: [createdById], references: [id])
  createdById Int
  items       TestRunItem[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([projectId])
  @@index([workspaceId])
  @@index([createdById])
}

model TestRunItem {
  id              Int           @id @default(autoincrement())
  testRun         TestRun       @relation(fields: [testRunId], references: [id])
  testRunId       Int
  testCase        TestCase      @relation(fields: [testCaseId], references: [id])
  testCaseId      Int
  // Snapshot data at time of run creation
  snapshotTitle   String
  snapshotPriority String
  // Execution result
  result          String?       // pass, fail, blocked, skipped
  executedBy      User?         @relation(fields: [executedById], references: [id])
  executedById    Int?
  executedAt      DateTime?
  comments        String?
  attachments     Attachment[]
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([testRunId])
  @@index([testCaseId])
  @@index([executedById])
}

model Attachment {
  id          Int          @id @default(autoincrement())
  entityType  String       // "TestRunItem", "Doc", etc.
  entityId    Int
  fileUrl     String
  fileName    String
  fileSize    Int?         // in bytes
  mimeType    String?
  uploadedBy  User         @relation(fields: [uploadedById], references: [id])
  uploadedById Int
  testRunItem TestRunItem? @relation(fields: [testRunItemId], references: [id])
  testRunItemId Int?
  uploadedAt  DateTime     @default(now())

  @@index([entityType, entityId])
  @@index([uploadedById])
  @@index([testRunItemId])
}

model FileAsset {
  id          Int       @id @default(autoincrement())
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId Int
  project     Project   @relation(fields: [projectId], references: [id])
  projectId   Int
  provider    String    // s3|minio|gdrive|external
  bucket      String
  key         String
  fileName    String?
  mimeType    String?
  sizeBytes   Int?
  sha256      String?
  previewKey  String?
  sourceUrl   String?
  expiresAt   DateTime?
  uploadedBy  User      @relation("FileAssetUploadedBy", fields: [uploadedById], references: [id])
  uploadedById Int
  uploadedAt  DateTime  @default(now())
  docAttachments DocAttachment[]

  @@index([workspaceId])
  @@index([projectId])
  @@index([provider, key])
  @@index([uploadedById])
}

model Doc {
  id           Int             @id @default(autoincrement())
  workspace    Workspace       @relation(fields: [workspaceId], references: [id])
  workspaceId  Int
  project      Project         @relation(fields: [projectId], references: [id])
  projectId    Int
  folder       DocFolder?      @relation(fields: [folderId], references: [id])
  folderId     Int?
  parent       Doc?            @relation("DocToDoc", fields: [parentId], references: [id])
  parentId     Int?
  children     Doc[]           @relation("DocToDoc")
  title        String
  type         String          @default("other")
  status       String          @default("draft")
  content      String
  tags         String[]
  order        Int             @default(0)
  version      Int             @default(1)
  createdBy    User            @relation("DocCreatedBy", fields: [createdById], references: [id])
  createdById  Int
  updatedBy    User            @relation("DocUpdatedBy", fields: [updatedById], references: [id])
  updatedById  Int
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  publishedAt  DateTime?
  archivedAt   DateTime?
  versions     DocVersion[]
  attachments  DocAttachment[]
  reviewWorkflow DocReviewWorkflow?
  comments     DocComment[]
  links        DocLink[]

  @@index([workspaceId])
  @@index([projectId])
  @@index([folderId])
  @@index([parentId])
  @@index([type])
  @@index([status])
}

model DocVersion {
  id           Int      @id @default(autoincrement())
  doc          Doc      @relation(fields: [docId], references: [id])
  docId        Int
  version      Int
  title        String
  content      String
  createdBy    User     @relation("DocVersionCreatedBy", fields: [createdById], references: [id])
  createdById  Int
  createdAt    DateTime @default(now())
  changeNote   String?

  @@index([docId])
  @@index([version])
}

model DocReviewWorkflow {
  id            Int       @id @default(autoincrement())
  doc           Doc       @relation(fields: [docId], references: [id])
  docId         Int       @unique
  requestedBy   User      @relation("DocReviewRequestedBy", fields: [requestedById], references: [id])
  requestedById Int
  reviewers     Int[]
  state         String    @default("pending") // pending | approved | rejected
  decidedBy     User?     @relation("DocReviewDecidedBy", fields: [decidedById], references: [id])
  decidedById   Int?
  decidedAt     DateTime?
  note          String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  actions       DocReviewAction[]

  @@index([docId])
  @@index([requestedById])
  @@index([decidedById])
}

model DocReviewAction {
  id          Int      @id @default(autoincrement())
  workflow    DocReviewWorkflow @relation(fields: [workflowId], references: [id])
  workflowId  Int
  action      String   // request | approve | reject
  note        String?
  actor       User     @relation("DocReviewActionActor", fields: [actorId], references: [id])
  actorId     Int
  createdAt   DateTime @default(now())

  @@index([workflowId])
  @@index([actorId])
}

model DocLink {
  id          Int      @id @default(autoincrement())
  doc         Doc      @relation(fields: [docId], references: [id])
  docId       Int
  entityType  String   // test_case | test_plan | test_run | bug | release | requirement
  entityId    String
  createdAt   DateTime @default(now())

  @@index([docId])
  @@index([entityType])
}

model DocFolder {
  id           Int        @id @default(autoincrement())
  workspace    Workspace  @relation(fields: [workspaceId], references: [id])
  workspaceId  Int
  project      Project    @relation(fields: [projectId], references: [id])
  projectId    Int
  parent       DocFolder? @relation("DocFolderToFolder", fields: [parentId], references: [id])
  parentId     Int?
  children     DocFolder[] @relation("DocFolderToFolder")
  name         String
  order        Int        @default(0)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  docs         Doc[]

  @@index([workspaceId])
  @@index([projectId])
  @@index([parentId])
}

model DocComment {
  id           Int      @id @default(autoincrement())
  doc          Doc      @relation(fields: [docId], references: [id])
  docId        Int
  version      Int?
  anchor       String?
  message      String
  createdBy    User     @relation("DocCommentCreatedBy", fields: [createdById], references: [id])
  createdById  Int
  createdAt    DateTime @default(now())
  resolvedAt   DateTime?
  resolvedBy   User?    @relation("DocCommentResolvedBy", fields: [resolvedById], references: [id])
  resolvedById Int?

  @@index([docId])
  @@index([createdById])
  @@index([resolvedById])
}

model DocTemplate {
  id           Int       @id @default(autoincrement())
  workspace    Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId  Int
  project      Project?  @relation(fields: [projectId], references: [id])
  projectId    Int?
  name         String
  type         String    @default("doc")
  content      String
  createdBy    User      @relation("DocTemplateCreatedBy", fields: [createdById], references: [id])
  createdById  Int
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([workspaceId])
  @@index([projectId])
  @@index([type])
}

model DocAttachment {
  id          Int        @id @default(autoincrement())
  doc         Doc        @relation(fields: [docId], references: [id])
  docId       Int
  fileAsset   FileAsset  @relation(fields: [fileAssetId], references: [id])
  fileAssetId Int
  caption     String?
  order       Int        @default(0)
  createdAt   DateTime   @default(now())

  @@index([docId])
  @@index([fileAssetId])
}

// Custom permission sets for roles in workspace
model RolePermissionSet {
  id          Int       @id @default(autoincrement())
  workspace   Workspace @relation(fields: [workspaceId], references: [id])
  workspaceId Int
  role        String    // Role name (e.g., "admin", "qa", "custom_role")
  permissions String[]  // Array of permission strings
  isDefault   Boolean   @default(false) // If true, this is the default set for this role
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([workspaceId, role])
  @@index([workspaceId])
}
